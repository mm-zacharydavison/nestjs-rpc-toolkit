# @zdavison/nestjs-rpc-toolkit

A TypeScript toolkit for type-safe RPC calls in NestJS monorepos. Enables seamless inter-service communication with compile-time type safety and automatic type generation.

[![npm version](https://badge.fury.io/js/%40zdavison%2Fnestjs-rpc-toolkit.svg)](https://badge.fury.io/js/%40zdavison%2Fnestjs-rpc-toolkit)

## Foreword

ü§ñ This README is generated by AI. I'll rewrite it later in a more human-friendly way.

## Features

- üõ°Ô∏è **Type Safety**: Full TypeScript support with generated types for RPC calls
- üèóÔ∏è **Decorator-Based**: Simple `@RpcController` and `@RpcMethod` decorators
- üîÑ **Auto-Generation**: Automatic TypeScript type generation from your RPC methods
- üì¶ **Monorepo Ready**: Designed for NestJS monorepos with wildcard package scanning
- üöÄ **Multiple Transports**: In-memory for development, TCP for production microservices
- ‚ö° **Zero Config**: Smart defaults with optional customization

## Quick Start

### 1. Installation

```bash
npm install @zdavison/nestjs-rpc-toolkit
```

### 2. Define RPC Methods

```typescript
import { RpcController, RpcMethod } from '@zdavison/nestjs-rpc-toolkit';

@RpcController('user') // Creates 'user.*' RPC patterns
export class UserService {
  @RpcMethod()
  async findOne(params: { id: string }): Promise<User> {
    // RPC pattern: 'user.findOne'
    return this.userRepository.findById(params.id);
  }

  @RpcMethod()
  async create(params: CreateUserDto): Promise<User> {
    // RPC pattern: 'user.create'
    return this.userRepository.create(params);
  }
}
```

### 3. Initialize RPC Package

```bash
npx @zdavison/nestjs-rpc-toolkit bootstrap
```

This creates:
- RPC package structure
- Configuration files
- Type generation scripts
- TypeScript setup

### 4. Generate Types

```bash
npm run generate:types
```

Generates type-safe interfaces:

```typescript
// Generated in your RPC package
export interface UserDomain {
  findOne(params: { id: string }): Promise<User>;
  create(params: CreateUserDto): Promise<User>;
}

export interface IRpcClient {
  user: UserDomain;
  product: ProductDomain;
  // ... other domains
}
```

### 5. Make Type-Safe RPC Calls

```typescript
import { MessageBus } from '@your-org/rpc'; // Your generated RPC package

@Injectable()
export class ProductService {
  constructor(private readonly rpc: MessageBus) {}

  async getProductWithOwner(productId: string) {
    // Type-safe RPC calls with auto-completion
    const product = await this.rpc.send('product.findOne', { id: productId });
    const owner = await this.rpc.send('user.findOne', { id: product.ownerId });

    return { product, owner };
  }
}
```

## Documentation

### @RpcController Decorator

The `@RpcController` decorator marks classes containing RPC methods:

```typescript
// Explicit prefix
@RpcController('user')
export class UserService { }

// Auto-inferred from class name
@RpcController() // Infers 'user' from 'UserService'
export class UserService { }

@RpcController() // Infers 'product' from 'ProductApplication'
export class ProductApplication { }
```

**Auto-inference rules:**
- Removes suffixes: `Service`, `Application`, `Handler`, `Repository`
- Converts to lowercase: `UserService` ‚Üí `user`

### @RpcMethod Decorator

Marks methods as RPC endpoints:

```typescript
@RpcController('user')
export class UserService {
  @RpcMethod()
  async findAll(): Promise<User[]> {
    // Pattern: 'user.findAll'
  }

  @RpcMethod()
  async findOne(params: { id: string }): Promise<User> {
    // Pattern: 'user.findOne'
  }
}
```

### Configuration

Create `nestjs-rpc-toolkit.config.json`:

```json
{
  "packages": [
    "packages/modules/*",
    "apps/specific-service"
  ],
  "outputDir": "packages/lib-rpc/src"
}
```

**Package paths support:**
- Glob patterns: `packages/modules/*`
- Specific paths: `apps/user-service`
- Multiple patterns in array

### Transport Options

#### In-Process Transport (Development)

```typescript
import { InProcessTransport } from '@zdavison/nestjs-rpc-toolkit';

@Module({
  imports: [
    InProcessTransport.forRoot(),
  ],
})
export class AppModule {}
```

#### TCP Transport (Production)

```typescript
import { TcpTransport } from '@zdavison/nestjs-rpc-toolkit';

@Module({
  imports: [
    TcpTransport.forRoot({
      host: 'localhost',
      port: 3001,
    }),
  ],
})
export class AppModule {}
```

## Examples

The `examples/` directory contains a complete monorepo setup:

```bash
cd examples
pnpm install
pnpm generate-rpc  # Generate RPC types
pnpm build         # Build all packages
pnpm dev          # Start API in development mode
```

### Example Structure

```
examples/
‚îú‚îÄ‚îÄ apps/api/                 # Main NestJS application
‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îú‚îÄ‚îÄ user-module/         # User domain module
‚îÇ   ‚îî‚îÄ‚îÄ auth-module/         # Auth domain module
‚îú‚îÄ‚îÄ lib-rpc/                 # Generated RPC types package
‚îî‚îÄ‚îÄ package.json
```

## Serialization Requirements

All RPC parameters and return types must be JSON-serializable for TCP transport:

‚úÖ **Allowed:**
- Primitives: `string`, `number`, `boolean`, `null`
- Plain objects: `{ name: string, age: number }`
- Arrays: `string[]`, `User[]`

‚ùå **Avoid:**
- Functions, callbacks
- Class instances (use plain objects/interfaces)
- `Buffer`, `Map`, `Set`
- `undefined` (use `null` instead)
- DOM elements

## API Reference

### Core Classes

- **`MessageBus<T>`**: Type-safe RPC client
- **`RpcTypesGenerator`**: Generates TypeScript types from RPC methods
- **`InProcessTransport`**: In-process transport for development
- **`TcpTransport`**: TCP transport for production

### Decorators

- **`@RpcController(prefix?)`**: Marks RPC controller classes
- **`@RpcMethod(pattern?)`**: Marks RPC endpoint methods

## Contributing

1. Fork the repository
2. Create your feature branch: `git checkout -b feature/my-feature`
3. Commit your changes: `git commit -am 'Add some feature'`
4. Push to the branch: `git push origin feature/my-feature`
5. Submit a pull request

## License

MIT

## Support

- [GitHub Issues](https://github.com/zdavison/nestjs-rpc-toolkit/issues)
- [Documentation](https://github.com/zdavison/nestjs-rpc-toolkit)

---

**Made for NestJS monorepos** üöÄ